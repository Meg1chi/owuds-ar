<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Teddy AR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

<style>
body { margin:0; overflow:hidden; }
</style>

<script>
AFRAME.registerComponent('gesture-handler', {
  init: function () {
    this.scale = 1;
    this.position = { x: 0, y: 0, z: -2 };
    this.startTouch = null;

    this.el.sceneEl.addEventListener('touchstart', (e) => {
      if (e.touches.length === 1) {
        this.startTouch = {
          x: e.touches[0].clientX,
          y: e.touches[0].clientY
        };
      }
    });

    this.el.sceneEl.addEventListener('touchmove', (e) => {

      // 1本指ドラッグ
      if (e.touches.length === 1 && this.startTouch) {
        let dx = e.touches[0].clientX - this.startTouch.x;
        let dy = e.touches[0].clientY - this.startTouch.y;

        // 動きをゆっくりに（0.002で減速）
        this.position.x += dx * 0.002;
        this.position.y -= dy * 0.002;

        this.el.setAttribute('position', this.position);

        this.startTouch = {
          x: e.touches[0].clientX,
          y: e.touches[0].clientY
        };
      }

      // 2本指ピンチ
      if (e.touches.length === 2) {
        let dx = e.touches[0].clientX - e.touches[1].clientX;
        let dy = e.touches[0].clientY - e.touches[1].clientY;
        let distance = Math.sqrt(dx * dx + dy * dy);

        if (!this.startDistance) {
          this.startDistance = distance;
        } else {
          let scaleFactor = distance / this.startDistance;
          this.scale *= scaleFactor;
          this.scale = Math.min(Math.max(this.scale, 0.3), 3);

          this.el.setAttribute('scale', {
            x: this.scale,
            y: this.scale,
            z: this.scale
          });

          this.startDistance = distance;
        }
      }

    });

    this.el.sceneEl.addEventListener('touchend', () => {
      this.startDistance = null;
      this.startTouch = null;
    });
  }
});
</script>

</head>

<body>

<a-scene
  vr-mode-ui="enabled: false"
  embedded
  renderer="logarithmicDepthBuffer: true;"
  arjs="sourceType: webcam; debugUIEnabled: false;"
>

  <a-entity position="0 0 -2" gesture-handler>

    <!-- 背景（2回り大きく） -->
    <a-plane
      src="background.png"
      position="0 0 -0.3"
      width="1.2"
      height="0.8"
      material="transparent: true"
    ></a-plane>

    <!-- 熊 -->
    <a-image
      src="teddy.png"
      position="0 -0.3 0"
      width="0.8"
      height="0.8"
      material="transparent: true"
      animation="property: position;
                 dir: alternate;
                 dur: 2000;
                 loop: true;
                 to: 0 -0.2 0"
    ></a-image>

  </a-entity>

  <a-camera></a-camera>

</a-scene>

</body>
</html>
