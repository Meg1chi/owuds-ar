<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Teddy AR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

<style>
body { margin:0; overflow:hidden; }
</style>

<script>
AFRAME.registerComponent('gesture-handler', {
  init: function () {
    this.scale = 1;
    this.el.sceneEl.addEventListener('touchmove', (e) => {
      if (e.touches.length === 1) {
        // ドラッグ移動
        let touch = e.touches[0];
        let x = (touch.clientX / window.innerWidth - 0.5) * 4;
        let y = -(touch.clientY / window.innerHeight - 0.5) * 4;
        this.el.setAttribute('position', { x: x, y: y, z: -2 });
      }

      if (e.touches.length === 2) {
        // ピンチ拡大縮小
        let dx = e.touches[0].clientX - e.touches[1].clientX;
        let dy = e.touches[0].clientY - e.touches[1].clientY;
        let distance = Math.sqrt(dx * dx + dy * dy);

        if (!this.startDistance) {
          this.startDistance = distance;
        } else {
          let scaleFactor = distance / this.startDistance;
          this.scale = Math.min(Math.max(scaleFactor, 0.3), 3);
          this.el.setAttribute('scale', {
            x: this.scale,
            y: this.scale,
            z: this.scale
          });
        }
      }
    });

    this.el.sceneEl.addEventListener('touchend', () => {
      this.startDistance = null;
    });
  }
});
</script>

</head>

<body>

<a-scene
  vr-mode-ui="enabled: false"
  embedded
  renderer="logarithmicDepthBuffer: true;"
  arjs="sourceType: webcam; debugUIEnabled: false;"
>

  <!-- まとめて操作するグループ -->
  <a-entity position="0 0 -2" gesture-handler>

    <!-- 背景（熊の奥に少し） -->
    <a-plane
      src="background.png"
      position="0 0 -0.3"
      width="0.8"
      height="0.5"
      material="transparent: true"
    ></a-plane>

    <!-- 熊 -->
    <a-image
      src="teddy.png"
      position="0 -0.3 0"
      width="0.8"
      height="0.8"
      material="transparent: true"
      animation="property: position;
                 dir: alternate;
                 dur: 2000;
                 loop: true;
                 to: 0 -0.2 0"
    ></a-image>

  </a-entity>

  <a-camera></a-camera>

</a-scene>

</body>
</html>
